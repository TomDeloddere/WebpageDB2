<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DB2 Backup and Recovery - Mainframe Edition</title>

    <style>
        button {
          background-color: #001a00; /* Dark green background */
          color: #33ff33; /* Bright green text */
          font-family: 'Courier New', monospace;
          font-weight: bold;
          border: 1px solid #33ff33;
          padding: 8px 15px;
          cursor: pointer;
          transition: all 0.3s;
          text-transform: uppercase;
          letter-spacing: 1px;
          display: flex; /* Align icon and text */
          align-items: center;
      }
      button:hover {
          background-color: rgba(51, 255, 51, 0.2);
          color: #ffffff; /* White text on hover */
          box-shadow: 0 0 8px rgba(51, 255, 51, 0.6);
      }
      button:disabled {
          background-color: #05050a; /* Darker background when disabled */
          color: #447744; /* Dimmed green text */
          border-color: #225522; /* Dimmed border */
          cursor: not-allowed;
          opacity: 0.6;
      }
      button .lucide {
          margin-right: 8px; /* Space before text */
      }
        /* General styles - Mainframe inspired but optimized for learning */
        body {
            background-color: #0a0a14;
            color: #b3ffb3;
            font-family: 'Courier New', monospace;
            line-height: 1.6;
            margin: 0;
            padding: 0;
            text-shadow: 0 0 2px rgba(179, 255, 179, 0.4);
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: rgba(10, 10, 20, 0.7);
            border: 1px solid #33ff33;
            box-shadow: 0 0 10px rgba(51, 255, 51, 0.3);
        }
        header {
            background-color: #001a00;
            padding: 20px;
            text-align: center;
            border-bottom: 2px solid #33ff33;
            margin-bottom: 30px;
        }
        h1 {
            color: #33ff33;
            font-size: 2.2rem;
            margin: 0;
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        nav {
            background-color: #001a00;
            padding: 10px 0;
            margin-bottom: 30px;
            border-top: 1px solid #33ff33; /* Added top border */
            border-bottom: 1px solid #33ff33;
        }
        nav ul {
            list-style-type: none;
            padding: 0;
            margin: 0;
            display: flex;
            justify-content: center;
            flex-wrap: wrap; /* Allow wrapping on smaller screens */
        }
        nav li {
            margin: 5px 15px; /* Add vertical margin for wrapped items */
        }
        nav a {
            color: #33ff33;
            text-decoration: none;
            font-weight: bold;
            padding: 5px 10px;
            border-radius: 3px;
            transition: all 0.3s;
        }
        nav a:hover {
            background-color: rgba(51, 255, 51, 0.2);
            color: #ffffff;
        }
        section {
            margin-bottom: 40px;
            padding: 25px; /* Increased padding */
            background-color: rgba(0, 26, 0, 0.4); /* Slightly adjusted background */
            border-left: 4px solid #33ff33; /* Increased border thickness */
            border-radius: 5px; /* Added slight rounding */
        }
        h2 {
            color: #00ff99;
            border-bottom: 2px solid #00ff99; /* Thicker border */
            padding-bottom: 12px; /* Increased padding */
            margin-bottom: 25px; /* Increased margin */
            font-size: 1.9rem; /* Slightly larger */
            text-transform: uppercase; /* Uppercase headings */
            letter-spacing: 1px;
        }
        h3 {
            color: #00ffcc;
            font-size: 1.5rem; /* Slightly larger */
            margin-top: 30px; /* Increased margin */
            margin-bottom: 15px;
            border-left: 3px solid #00ffcc; /* Accent border */
            padding-left: 10px;
        }
        h4 { /* Style for h4 */
            color: #00e6b8; /* Slightly different color */
            font-size: 1.3rem; /* Slightly larger */
            margin-top: 25px; /* Increased margin */
            margin-bottom: 10px;
            text-decoration: underline;
            text-decoration-color: #00e6b8;
        }
        p {
            margin-bottom: 20px;
            font-size: 1.1rem;
            text-align: justify; /* Justify text for block appearance */
        }
        .code-block {
            background-color: #000000;
            border: 1px solid #33ff33;
            border-radius: 5px;
            padding: 20px; /* Increased padding */
            margin: 25px 0; /* Increased margin */
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            font-size: 1.0rem; /* Adjusted font size */
            color: #66ff66; /* Slightly softer green */
            white-space: pre; /* Preserve whitespace and line breaks */
            box-shadow: inset 0 0 8px rgba(51, 255, 51, 0.2); /* Inner glow */
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 25px 0; /* Increased margin */
            background-color: rgba(0, 0, 0, 0.6); /* Darker background */
            border: 1px solid #33ff33; /* Add outer border */
        }
        th, td {
            padding: 14px 18px; /* Increased padding */
            text-align: left;
            border: 1px solid #228822; /* Internal cell borders */
        }
        th {
            background-color: #002a00; /* Darker header */
            color: #00ff99;
            text-transform: uppercase;
            font-size: 1.0rem; /* Larger header font */
            letter-spacing: 1.5px; /* Increased spacing */
            border-bottom: 2px solid #33ff33; /* Thicker bottom border */
        }
        tr:hover {
            background-color: rgba(51, 255, 51, 0.15); /* Slightly stronger hover */
        }
        ul, ol {
            padding-left: 30px; /* Increased padding */
            margin-bottom: 20px;
            list-style-type: square; /* Changed bullet style */
        }
        li {
            margin-bottom: 12px; /* Increased spacing */
        }
        /* Custom list style for better visibility */
        ul li::marker {
            color: #00ff99;
        }
        ol {
            list-style-type: decimal;
        }
        ol li::marker {
            color: #00ffcc;
            font-weight: bold;
        }
        .note {
            background-color: rgba(0, 26, 51, 0.6); /* Darker blue */
            border-left: 5px solid #3399ff; /* Thicker border */
            padding: 18px; /* Increased padding */
            margin: 25px 0; /* Increased margin */
            color: #ade6ff; /* Lighter blue text */
            border-radius: 4px;
        }
        .important {
            background-color: rgba(51, 0, 0, 0.6); /* Darker red */
            border-left: 5px solid #ff3333; /* Thicker border */
            padding: 18px; /* Increased padding */
            margin: 25px 0; /* Increased margin */
            color: #ffcccc; /* Lighter red text */
            border-radius: 4px;
            font-weight: bold;
        }
        .terminal {
            background-color: #05050a; /* Slightly different black */
            border-radius: 5px;
            padding: 20px; /* Increased padding */
            margin: 25px 0; /* Increased margin */
            font-family: 'Courier New', monospace;
            color: #99ff99; /* Lighter green */
            border: 1px dashed #33ff33; /* Dashed border */
            position: relative;
            white-space: pre;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        .terminal::before {
            content: "SYS_PROMPT >"; /* Changed prompt */
            color: #00ff99;
            font-weight: bold;
            margin-right: 10px;
            display: block; /* Make prompt appear on its own line */
            margin-bottom: 8px;
        }
        .diagram {
            background-color: #000500; /* Very dark green */
            border: 1px solid #33ff33;
            padding: 25px; /* Increased padding */
            margin: 25px 0; /* Increased margin */
            text-align: center;
            font-style: italic;
            color: #99ff99;
            border-radius: 5px;
        }
        footer {
            text-align: center;
            padding: 25px; /* Increased padding */
            margin-top: 50px; /* Increased margin */
            border-top: 2px solid #33ff33; /* Thicker border */
            font-size: 1.0rem; /* Larger font */
            color: #66ff66;
        }
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            nav ul {
                flex-direction: column;
                align-items: center;
            }
            nav li {
                margin: 5px 0;
            }
            h1 {
                font-size: 1.8rem;
            }
            h2 {
                font-size: 1.5rem;
            }
            h3 {
                font-size: 1.2rem;
            }
            h4 {
                font-size: 1.1rem;
            }
            p {
                font-size: 1.0rem; /* Adjust paragraph font size */
                text-align: left; /* Revert justification on small screens if needed */
            }
            .code-block, .terminal {
                font-size: 0.9rem; /* Smaller code font on mobile */
            }
        }
    </style>
</head>
<body>

    <div class="container">

        <header>
            <h1>DB2 Backup and Recovery</h1>
            <button id="back-to-quiz-btn">
                <span class="lucide">&#xe3a7;</span> Back To Mainpage
            </button>
            </header>

        <nav>
            <ul>
                <li><a href="#intro">Introduction</a></li>
                <li><a href="#mechanisms">Recovery Mechanisms</a></li>
                <li><a href="#scenarios">Recovery Scenarios</a></li>
                <li><a href="#recover_utility">RECOVER Utility</a></li>
                <li><a href="#copy_utility">COPY Utility</a></li>
                <li><a href="#strategy">Backup Strategy</a></li>
                <li><a href="#quiesce">QUIESCE Utility</a></li>
                <li><a href="#system_backup">System-Level Backup</a></li>
                <li><a href="#planning">Recovery Planning</a></li>
                <li><a href="#procedures">Recovery Procedures</a></li>
                <li><a href="#advanced">Advanced Topics</a></li>
                <li><a href="#conclusion">Conclusion</a></li>
            </ul>
        </nav>

        <section id="intro">
            <h2>Introduction to DB2 Data Protection</h2>
            <p>
                Data protection is a critical aspect of any DB2 environment, particularly in mainframe implementations where databases often support mission-critical business operations. A comprehensive backup and recovery strategy ensures business continuity, minimizes data loss, and provides mechanisms to recover from various failure scenarios. DB2 for z/OS provides robust capabilities that enable organizations to implement multi-layered data protection approaches.
            </p>
            <p>
                Understanding the fundamental goals is key before diving into the technical details. These objectives guide the design and implementation of your entire data protection strategy.
            </p>
            <h3>Primary Goals of DB2 Backup and Recovery</h3>
            <ul>
                <li><strong>Data Availability:</strong> Ensuring data remains accessible with minimal disruption. Downtime costs money!</li>
                <li><strong>Data Integrity:</strong> Preserving the correctness and completeness of data. Corrupt data is often worse than no data.</li>
                <li><strong>Recovery Point Objective (RPO):</strong> Minimizing the amount of data that could be lost in a failure. How much data can you afford to lose? An hour? A minute?</li>
                <li><strong>Recovery Time Objective (RTO):</strong> Minimizing the time required to restore normal operations after a failure. How quickly do you need to be back online?</li>
                <li><strong>Regulatory Compliance:</strong> Meeting legal and industry requirements for data protection (e.g., GDPR, HIPAA, SOX). Auditors love good backup plans.</li>
                <li><strong>Business Continuity:</strong> Supporting enterprise disaster recovery planning. What happens if the whole data center goes offline?</li>
            </ul>
            <p>
                Effective DB2 data protection requires understanding the available tools (like COPY, RECOVER, QUIESCE), implementing appropriate procedures (scheduling, retention), and regularly testing recovery scenarios to validate the strategy's effectiveness. Don't wait for a real disaster to test your plan!
            </p>
            <div class="note">
                <strong>Note:</strong> RPO and RTO are often the most significant drivers for designing a backup and recovery strategy. They dictate backup frequency, technology choices, and recovery procedures.
            </div>
        </section>

        <section id="mechanisms">
            <h2>DB2 Recovery Mechanisms</h2>
            <p>
                DB2 relies heavily on its logging mechanism to ensure data consistency and enable recovery from failures. Understanding how the log works is fundamental to understanding DB2 recovery.
            </p>

            <h3>Understanding Recovery Log Operations</h3>
            <p>
                The DB2 recovery log is the foundation of the recovery process, recording all changes made to DB2 data. Think of it as a detailed journal of everything important that happens to your data.
            </p>
            <h4>Log Record Structure:</h4>
            <ul>
                <li><strong>Unit of Recovery (UR) ID:</strong> Identifies the transaction associated with the log record.</li>
                <li><strong>Log Record Sequence Number (LRSN/RBA):</strong> A unique, ever-increasing value identifying the log record's position. Crucial for point-in-time recovery. RBA (Relative Byte Address) is the older term, LRSN (Log Record Sequence Number) is used in data sharing.</li>
                <li><strong>Record Type:</strong> Indicates the type of operation (e.g., INSERT, UPDATE, DELETE, COMMIT, ABORT, Checkpoint).</li>
                <li><strong>Before/After Images:</strong> Contains data values before (for Undo) and after (for Redo) the change.</li>
                <li><strong>Object Identification:</strong> Identifies the specific database, tablespace, page, and row affected.</li>
            </ul>

            <h4>Key Log Components:</h4>
            <ul>
                <li><strong>Active Log Datasets:</strong> Circular datasets where log records are initially written. DB2 typically uses multiple active log datasets.</li>
                <li><strong>Archive Log Datasets:</strong> When an active log fills up, DB2 offloads its contents to an archive log dataset (usually on tape or DASD). These are essential for recovery beyond the scope of the active logs.</li>
                <li><strong>Bootstrap Data Set (BSDS):</strong> A critical dataset containing inventory information about active and archive logs, checkpoint information, and system status. If you lose the BSDS, recovery becomes *very* difficult.</li>
                <li><strong>Dual Logging:</strong> DB2 writes log records to two copies of the active log datasets simultaneously (primary and secondary) to protect against single log dataset failures. Highly recommended!</li>
            </ul>
            <pre class="code-block">
-- Sample Log Record (Conceptual Representation) --
LRSN: 00D1:C3B0:A100:0001:00
URID: 000000A511F3
TYPE: UPDATE
DBID: 0100 PSID: 0005 PAGE: 00001A
ROW: 05
BEFORE_IMAGE: 'OLD_VALUE'
AFTER_IMAGE:  'NEW_VALUE'
TIMESTAMP: 2025-04-07-12.30.00.123456
            </pre>

            <h4>Log Operations:</h4>
            <ul>
                <li><strong>Write-Ahead Logging (WAL):</strong> DB2 writes log records for changes *before* writing the changed data pages to disk. This ensures that if a failure occurs, the logs contain enough information to recover.</li>
                <li><strong>Redo Processing:</strong> During forward recovery (or restart), DB2 reapplies committed changes recorded in the log (using After Images) that might not have made it to disk before a failure.</li>
                <li><strong>Undo Processing:</strong> During rollback (or restart), DB2 reverses uncommitted changes recorded in the log (using Before Images) to restore data consistency.</li>
                <li><strong>Checkpoints:</strong> DB2 periodically records checkpoint information (in the log and BSDS) indicating a point of consistency where all changes prior to the checkpoint are guaranteed to be on disk. This speeds up restart recovery by limiting how far back DB2 needs to read the log.</li>
                <li><strong>Log Archival:</strong> The process of offloading filled active logs to archive storage.</li>
                <li><strong>SYSLGRNX Recording:</strong> A directory table (SYSIBM.SYSLGRNX) that records the range of log RBAs/LRSNs affecting each tablespace page set. This helps speed up recovery by identifying which logs are needed for a specific object.</li>
            </ul>
            <div class="important">
                <strong>Critical:</strong> Protecting the DB2 logs (Active, Archive, BSDS) is paramount. Loss or corruption of logs can lead to significant data loss. Implement dual logging and robust backup procedures for archive logs and the BSDS.
            </div>
        </section>

        <section id="scenarios">
            <h2>Common Recovery Scenarios</h2>
            <p>
                DB2 is designed to handle various failure types. Understanding these scenarios helps in planning appropriate recovery strategies.
            </p>
            <ul>
                <li>
                    <strong>System Failure:</strong> An unexpected outage of the entire DB2 subsystem or the z/OS LPAR (e.g., power loss, operating system crash). DB2 performs automatic restart recovery upon startup, using the logs to perform both Undo and Redo processing to bring the system to a consistent state.
                </li>
                <li>
                    <strong>Media Failure:</strong> Loss or corruption of DASD volumes containing DB2 data (tablespaces, indexspaces) or logs. This requires manual intervention involving restoring backups (image copies) and applying log records using the `RECOVER` utility.
                </li>
                <li>
                    <strong>Application Failure:</strong> An error within an application program causing incorrect data changes or abnormal termination. Recovery might involve rolling back the specific transaction (if caught early) or performing point-in-time recovery of affected objects to a state before the error occurred.
                </li>
                <li>
                    <strong>Transaction Failure:</strong> A single transaction aborts due to constraint violations, deadlocks, or explicit ROLLBACK statements. DB2 automatically performs Undo processing for the failed transaction using the active log.
                </li>
                <li>
                    <strong>Disaster Recovery:</strong> Loss of the entire primary data center. Recovery involves restoring system-level backups and logs at a remote disaster recovery site and restarting DB2 there. This requires significant planning and specialized procedures.
                </li>
            </ul>
            <div class="diagram">
                Conceptual Flow: Failure -> Detection -> Diagnosis -> Recovery Procedure -> Validation
            </div>
            <p>
                Each scenario requires different recovery actions, highlighting the need for a flexible strategy incorporating various tools and techniques.
            </p>
        </section>

        <section id="recover_utility">
            <h2>The RECOVER Utility</h2>
            <p>
                The `RECOVER` utility is the workhorse for restoring DB2 objects (tablespaces and indexes) from backups and applying log records to bring them to a consistent state. It's essential for handling media failures and performing point-in-time recoveries.
            </p>
            <h3>Key RECOVER Options:</h3>
            <p>Understanding the various options is crucial for performing the correct type of recovery.</p>
            <table>
                <thead>
                    <tr>
                        <th>Option</th>
                        <th>Description</th>
                        <th>Common Use Case</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>(Default - No Option)</td>
                        <td>Recovers to the current point in time using the most recent image copy and all subsequent logs.</td>
                        <td>Standard recovery after media failure.</td>
                    </tr>
                    <tr>
                        <td><code>TORBA &lt;rba-value&gt;</code> / <code>TOLOGPOINT &lt;lrsn-value&gt;</code></td>
                        <td>Recovers to a specific log RBA (Relative Byte Address) or LRSN (Log Record Sequence Number).</td>
                        <td>Precise point-in-time recovery, often used after application errors.</td>
                    </tr>
                    <tr>
                        <td><code>TOCOPY &lt;dataset-name&gt;</code></td>
                        <td>Recovers using a specific image copy dataset (must be registered in SYSCOPY). Log apply follows.</td>
                        <td>Recovering from a known good backup before a specific event.</td>
                    </tr>
                    <tr>
                        <td><code>TOLASTCOPY</code></td>
                        <td>Recovers using the most recent image copy registered in SYSCOPY for the object. Log apply follows.</td>
                        <td>Recovering to the point of the last successful backup.</td>
                    </tr>
                    <tr>
                        <td><code>TOLASTFULLCOPY</code></td>
                        <td>Recovers using the most recent FULL image copy registered in SYSCOPY. Log apply follows.</td>
                        <td>Similar to TOLASTCOPY, but ensures starting from a full backup.</td>
                    </tr>
                    <tr>
                        <td><code>LOGONLY</code></td>
                        <td>Applies log records without restoring an image copy first. Assumes the object is physically present but potentially inconsistent.</td>
                        <td>Recovering from certain types of partial failures or inconsistencies where data exists but needs log updates. Use with caution!</td>
                    </tr>
                     <tr>
                        <td><code>PARALLEL(&lt;num&gt;)</code></td>
                        <td>Specifies the number of parallel tasks for log apply, potentially speeding up recovery.</td>
                        <td>Recovering large objects or multiple objects concurrently.</td>
                    </tr>
                    <tr>
                        <td><code>DSNUM &lt;integer&gt; | ALL</code></td>
                        <td>Specifies recovery for a specific partition (by its number) or all partitions of a partitioned object.</td>
                        <td>Recovering individual partitions after localized failures.</td>
                    </tr>
                </tbody>
            </table>

            <pre class="code-block">
-- Sample RECOVER JCL Step --
//RECOVTS  EXEC PGM=DSNUTILB,REGION=0M,
//         PARM='DB2X,RECOVERTS'  <-- Subsystem ID, Your Job Name
//STEPLIB  DD DISP=SHR,DSN=DB2.V12.SDSNLOAD <-- Your DB2 Load Library
//SYSPRINT DD SYSOUT=*
//SYSUT1   DD UNIT=SYSDA,SPACE=(CYL,(50,10))
//SYSIN    DD *
  RECOVER TABLESPACE DSN8D12A.DSN8S12E   <-- Target Tablespace
          DSNUM ALL                     <-- Recover all partitions/entire object
          TORBA X'00D1C3B0A1000000'      <-- Example: Recover to specific RBA
  /* Or use TOLASTCOPY, TOLOGPOINT etc. */
/*
</pre>
            <div class="note">
                <strong>Recovery Advisor:</strong> DB2 provides tools (like `REPORT RECOVERY`) that can help identify the necessary image copies and log datasets required for a specific recovery scenario. Leverage these tools!
            </div>

            <h3>Index Recovery:</h3>
            <p>
                Indexes often need recovery alongside their tablespaces.
            </p>
            <ul>
                <li><strong>`RECOVER INDEX`</strong>: Similar to tablespace recovery, uses index image copies (if taken) and logs.</li>
                <li><strong>`REBUILD INDEX`</strong>: Rebuilds the index structure by scanning the tablespace data. Often faster than `RECOVER INDEX` if no recent index copy exists or if the tablespace itself was just recovered. DB2 often handles index recovery automatically during tablespace recovery.</li>
            </ul>
        </section>

        <section id="copy_utility">
            <h2>The COPY Utility</h2>
            <p>
                The `COPY` utility is used to create image copy backups of tablespaces and indexspaces. These image copies are the foundation for media recovery using the `RECOVER` utility.
            </p>
            <h3>Types of Image Copies:</h3>
            <ul>
                <li><strong>Full Image Copy (FIC):</strong> A complete copy of all pages in the object at the time the copy was taken. Usually specified with `COPY TABLESPACE ... FULL YES`.</li>
                <li><strong>Incremental Image Copy (IIC):</strong> Copies only the pages that have changed since the last full or incremental image copy. Requires a prior full copy as a base. Usually specified with `COPY TABLESPACE ... FULL NO` (or by default). Faster than full copies but requires more complex recovery (merging).</li>
            </ul>
            <h3>Key COPY Options:</h3>
             <table>
                <thead>
                    <tr>
                        <th>Option</th>
                        <th>Description</th>
                        <th>Consideration</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><code>FULL YES | NO</code></td>
                        <td>Specifies whether to take a Full (YES) or Incremental (NO - default) copy.</td>
                        <td>Balance backup time vs. recovery complexity.</td>
                    </tr>
                    <tr>
                        <td><code>SHRLEVEL NONE | REFERENCE | CHANGE</code></td>
                        <td>Controls the level of concurrent access allowed during the copy. NONE=No access, REFERENCE=Read-only, CHANGE=Read/Write (fuzzy copy).</td>
                        <td>Impacts application availability vs. recovery point precision. SHRLEVEL CHANGE requires log apply during recovery.</td>
                    </tr>
                    <tr>
                        <td><code>DSNUM &lt;integer&gt; | ALL</code></td>
                        <td>Specifies copying a specific partition or all partitions.</td>
                        <td>Allows for partition-level backup strategies.</td>
                    </tr>
                    <tr>
                        <td><code>COPYDDN (&lt;ddname&gt;, &lt;ddname&gt;)</code></td>
                        <td>Specifies the DDnames for the primary and optional secondary output copy datasets.</td>
                        <td>Standard JCL requirement for output. Dual copies recommended.</td>
                    </tr>
                    <tr>
                        <td><code>RECOVERYDDN (&lt;ddname&gt;, &lt;ddname&gt;)</code></td>
                        <td>Specifies DDnames for recovery-site copies (often used with disaster recovery).</td>
                        <td>Facilitates DR planning.</td>
                    </tr>
                    <tr>
                        <td><code>CHANGELIMIT &lt;integer&gt;</code></td>
                        <td>Forces a full copy if the percentage of changed pages exceeds the specified limit.</td>
                        <td>Automates switch from incremental to full based on change activity.</td>
                    </tr>
                    <tr>
                        <td><code>CONCURRENT</code></td>
                        <td>Attempts to create a consistent copy even with SHRLEVEL CHANGE by coordinating with logging. Often used with FlashCopy.</td>
                        <td>Provides a more consistent point-in-time with concurrent access.</td>
                    </tr>
                    <tr>
                        <td><code>FLASHCOPY YES | NO | CONSISTENT</code></td>
                        <td>Utilizes storage subsystem's FlashCopy capability for near-instantaneous copies. CONSISTENT attempts a transactionally consistent FlashCopy.</td>
                        <td>Requires specific hardware; significantly reduces backup windows.</td>
                    </tr>
                </tbody>
            </table>
            <pre class="code-block">
-- Sample COPY JCL Step --
//COPYTS   EXEC PGM=DSNUTILB,REGION=0M,
//         PARM='DB2X,COPYTS'
//STEPLIB  DD DISP=SHR,DSN=DB2.V12.SDSNLOAD
//SYSPRINT DD SYSOUT=*
//SYSUT1   DD UNIT=SYSDA,SPACE=(CYL,(10,5))
//SYSCOPY  DD DSN=DB2X.DBBACKUP.MYDB.MYTS.FIC.D&LYYMMDD..T&LHHMMSS,
//         DISP=(NEW,CATLG,CATLG),UNIT=TAPE,VOL=SER=BACKUP
//SYSIN    DD *
  COPY TABLESPACE MYDB.MYTS   <-- Target Tablespace
       DSNUM ALL
       FULL YES               <-- Take a Full Image Copy
       SHRLEVEL REFERENCE     <-- Allow Read-Only Access
       COPYDDN(SYSCOPY)
/*
</pre>
            <div class="note">
                <strong>SYSCOPY Catalog Table:</strong> Every successful `COPY` operation registers information about the image copy (dataset name, timestamp, RBA/LRSN, type) in the `SYSIBM.SYSCOPY` catalog table. The `RECOVER` utility relies on this table to find the necessary backups. Use `MODIFY RECOVERY` to delete obsolete entries.
            </div>
        </section>

        <section id="strategy">
            <h2>Backup Strategy Design</h2>
            <p>
                Designing an effective backup strategy involves balancing recovery requirements (RPO/RTO) with operational constraints (backup windows, resources, cost).
            </p>
            <h3>Key Considerations:</h3>
            <ul>
                <li><strong>Recovery Objectives (RPO/RTO):</strong> As discussed, these are primary drivers. Lower RPO/RTO usually means more frequent backups and potentially more sophisticated technology (like FlashCopy).</li>
                <li><strong>Data Change Rate:</strong> High-volume transactional tablespaces may require more frequent backups (perhaps incremental) than relatively static ones.</li>
                <li><strong>Backup Window Availability:</strong> How much time is available for backup processing without impacting critical online or batch workloads? SHRLEVEL CHANGE copies might be needed if windows are tight.</li>
                <li><strong>Object Size and Partitioning:</strong> Large objects might benefit from partition-level backups or incremental strategies.</li>
                <li><strong>Criticality of Data:</strong> Mission-critical data demands more robust and frequent backups than less critical data.</li>
                <li><strong>System Objects:</strong> Don't forget to back up critical DB2 system objects like the Catalog (DSNDB06) and Directory (DSNDB01). These have specific recovery procedures.</li>
                <li><strong>Backup Retention:</strong> How long must backups be kept for operational recovery or compliance reasons? This impacts storage requirements.</li>
                <li><strong>Storage Media:</strong> DASD vs. Tape vs. Virtual Tape (VTL). Consider cost, speed, and reliability.</li>
                <li><strong>Disaster Recovery Requirements:</strong> Does the strategy need to support recovery at a remote site? This requires offsite backup storage and potentially system-level backups.</li>
            </ul>
            <h4>Example Strategy Elements:</h4>
            <ol>
                <li>Daily Incremental Copies (SHRLEVEL CHANGE) for high-volume OLTP tablespaces.</li>
                <li>Weekly Full Copies (SHRLEVEL REFERENCE) for all critical tablespaces during off-peak hours.</li>
                <li>Monthly Full Copies archived for long-term retention.</li>
                <li>Daily backups of the DB2 Catalog and Directory.</li>
                <li>Regular `MODIFY RECOVERY` jobs to prune old SYSCOPY entries.</li>
                <li>Periodic full system backups for DR purposes.</li>
            </ol>
            <div class="important">
                <strong>Strategy is Key:</strong> A well-thought-out strategy, documented and tested, is more valuable than simply running COPY jobs randomly. Tailor the strategy to *your* specific environment and requirements.
            </div>
        </section>

        <section id="quiesce">
            <h2>The QUIESCE Utility</h2>
            <p>
                The `QUIESCE` utility doesn't create a backup itself, but it plays a crucial role in establishing a point of consistency across one or more tablespaces before taking backups, especially system-level backups or application-managed backups.
            </p>
            <h3>Purpose and Function:</h3>
            <ul>
                <li>Establishes a point of consistency (a specific log RBA/LRSN) across a set of specified tablespaces or an entire DB2 system.</li>
                <li>Ensures all in-flight updates to the specified objects are completed or rolled back.</li>
                <li>Briefly prevents new write activity on the specified objects while the consistent point is established.</li>
                <li>Records the consistency point RBA/LRSN in the `SYSIBM.SYSCOPY` table for the specified objects.</li>
            </ul>
            <h3>Key QUIESCE Options:</h3>
            <ul>
                <li><strong><code>TABLESPACESET</code>:</strong> Specifies that all tablespaces involved in referential integrity constraints with the explicitly listed tablespaces should also be quiesced. Ensures RI consistency.</li>
                <li><strong><code>WRITE(YES|NO)</code>:</strong> Controls whether DB2 attempts to write updated pages from buffer pools to disk during the quiesce operation (default is YES).</li>
                <li><strong><code>HOLD|NOHOLD</code>:</strong> HOLD keeps the quiesce lock until explicitly released (e.g., by `QUIESCE RELEASE`), while NOHOLD (default) releases locks immediately after the point is established. HOLD is often used with system-level backups.</li>
            </ul>
            <pre class="code-block">
-- Sample QUIESCE JCL Step --
//QUIESCE  EXEC PGM=DSNUTILB,REGION=0M,
//         PARM='DB2X,QUIESCEJ'
//STEPLIB  DD DISP=SHR,DSN=DB2.V12.SDSNLOAD
//SYSPRINT DD SYSOUT=*
//SYSIN    DD *
  QUIESCE TABLESPACE MYDB.MYTS1, MYDB.MYTS2
          TABLESPACESET   <-- Include related tablespaces for RI
          WRITE(YES)
/*
</pre>
            <p>
                The RBA/LRSN recorded by `QUIESCE` can be used as a target point for subsequent `RECOVER ... TORBA/TOLOGPOINT` operations, ensuring all related objects are recovered to the same consistent moment.
            </p>
        </section>

        <section id="system_backup">
            <h2>System-Level Backups</h2>
            <p>
                For certain scenarios, particularly Disaster Recovery, backing up the entire DB2 subsystem as a single entity can be more efficient than managing individual object copies. DB2 provides the `BACKUP SYSTEM` utility for this purpose.
            </p>
            <h3>BACKUP SYSTEM Utility:</h3>
            <ul>
                <li>Creates a consistent backup of all DB2 data volumes and log volumes at a specific point in time.</li>
                <li>Typically leverages storage subsystem capabilities like FlashCopy or SnapShot for speed.</li>
                <li>Requires careful coordination with z/OS system-level backup procedures.</li>
                <li>The corresponding recovery utility is `RESTORE SYSTEM`.</li>
            </ul>
            <h4>Advantages:</h4>
            <ul>
                <li><strong>Speed:</strong> Backup windows can be significantly reduced compared to numerous object-level copies.</li>
                <li><strong>Simplicity:</strong> Manages the entire system as one unit.</li>
                <li><strong>Consistency:</strong> Provides a single point of consistency across the entire subsystem.</li>
            </ul>
            <h4>Limitations/Considerations:</h4>
            <ul>
                <li><strong>Granularity:</strong> Recovery is typically at the full system level; recovering individual objects from a system-level backup can be complex or impossible.</li>
                <li><strong>Hardware Dependency:</strong> Often relies on specific storage hardware features.</li>
                <li><strong>Complexity:</strong> Requires careful planning and integration with z/OS procedures.</li>
            </ul>
            <pre class="code-block">
-- Sample BACKUP SYSTEM JCL Step (Conceptual) --
//BACKSYS  EXEC PGM=DSNUTILB,REGION=0M,
//         PARM='DB2X,BACKSYS'
//STEPLIB  DD DISP=SHR,DSN=DB2.V12.SDSNLOAD
//SYSPRINT DD SYSOUT=*
//SYSIN    DD *
  BACKUP SYSTEM FULL        <-- Or COPYPOOL for specific copy pool
         DUMPCLASS(MYDUMP)  <-- Specify dump class for output
         SHRLEVEL NONE      <-- Typically requires exclusive access or coordination
/* Note: Actual implementation often involves system-level utilities like DFSMSdss */
</pre>
            <p>
                System-level backups are powerful for DR but usually complement, rather than replace, object-level image copies for operational recovery needs.
            </p>
        </section>

        <section id="planning">
            <h2>Recovery Planning & Preparation</h2>
            <p>
                Having backups is only half the battle; a well-defined and tested recovery plan is essential to meet RTOs and ensure successful restoration after a failure.
            </p>
            <h3>Key Elements of a Recovery Plan:</h3>
            <ul>
                <li><strong>Documentation:</strong> Clear, concise, and readily accessible procedures for various recovery scenarios (media failure, application error, DR). Include contact lists, escalation paths, and required resources. Keep it updated!</li>
                <li><strong>Testing:</strong> Regularly test recovery procedures in a non-production environment. This validates the plan, identifies issues, familiarizes staff, and provides realistic RTO estimates. Test different scenarios!</li>
                <li><strong>Validation:</strong> After a recovery test (or actual recovery), validate data integrity and application functionality thoroughly.</li>
                <li><strong>Resource Availability:</strong> Ensure necessary resources (personnel, hardware, software licenses, network bandwidth, backup media) are available when needed, especially for DR.</li>
                <li><strong>Automation:</strong> Automate recovery steps where possible using JCL, REXX, or specialized tools to reduce manual errors and speed up the process.</li>
                <li><strong>Monitoring:</strong> Monitor backup job success, log archival status, and available recovery resources proactively.</li>
                <li><strong>Tools:</strong> Familiarize staff with recovery-related utilities and tools like `RECOVER`, `REPORT RECOVERY`, `MODIFY RECOVERY`, and potentially vendor products.</li>
            </ul>
            <div class="terminal">
SYS_PROMPT > //REPORT JOB (ACCT),'RECOVERY REPORT',CLASS=A,...
SYS_PROMPT > //STEP1    EXEC PGM=DSNUTILB,PARM='DB2X,REPORT'
SYS_PROMPT > //STEPLIB  DD DISP=SHR,DSN=DB2.V12.SDSNLOAD
SYS_PROMPT > //SYSPRINT DD SYSOUT=*
SYS_PROMPT > //SYSIN    DD *
SYS_PROMPT >   REPORT RECOVERY TABLESPACE MYDB.MYTS
SYS_PROMPT > /*
SYS_PROMPT > //* This job uses REPORT RECOVERY to list needed recovery assets.
            </div>
            <div class="important">
                <strong>Test, Test, Test!</strong> An untested recovery plan is just a document. Regular, realistic testing is the only way to ensure you can actually recover when needed.
            </div>
        </section>

        <section id="procedures">
            <h2>Recovery Procedures</h2>
            <p>
                This section outlines common recovery procedures for different situations. Specific JCL and steps will vary based on the exact scenario and local standards.
            </p>

            <h3>Object-Level Recovery:</h3>
            <ul>
                <li><strong>Tablespace Recovery (Full):</strong>
                    <ol>
                        <li>Identify the failure (e.g., I/O errors on tablespace dataset).</li>
                        <li>Use `REPORT RECOVERY` to identify needed image copies and logs.</li>
                        <li>Allocate necessary datasets if restoring to new volumes.</li>
                        <li>Run `RECOVER TABLESPACE ...` (potentially with `TORBA` or `TOLOGPOINT` if needed).</li>
                        <li>Run `REBUILD INDEX` or `RECOVER INDEX` for associated indexes if necessary.</li>
                        <li>Validate data and application functionality.</li>
                    </ol>
                </li>
                <li><strong>Index Recovery (Standalone):</strong>
                    <ol>
                        <li>Identify index corruption or need for recovery.</li>
                        <li>Run `RECOVER INDEX ...` (if valid image copy exists) OR `REBUILD INDEX ...`.</li>
                        <li>Validate index consistency.</li>
                    </ol>
                </li>
                <li><strong>Partition Recovery:</strong>
                    <ol>
                        <li>Identify the failed partition.</li>
                        <li>Run `RECOVER TABLESPACE ... DSNUM <n> ...`.</li>
                        <li>Run `REBUILD INDEX ... PART <n>` for associated partitioned indexes.</li>
                        <li>Validate data in the recovered partition.</li>
                    </ol>
                </li>
                <li><strong>Point-in-Time (PIT) Recovery:</strong>
                    <ol>
                        <li>Determine the target RBA/LRSN or timestamp *before* the logical error occurred.</li>
                        <li>Identify all related tablespaces (using `REPORT TABLESPACESET` or application knowledge).</li>
                        <li>Run `RECOVER TABLESPACE ... TORBA/TOLOGPOINT ...` for *all* related tablespaces to the *same* point.</li>
                        <li>Run `REBUILD INDEX` for associated indexes.</li>
                        <li>Validate data consistency across recovered objects.</li>
                    </ol>
                    <div class="important">PIT recovery can be complex, especially with referential integrity. Ensure all dependent objects are recovered to the same point to avoid inconsistencies.</div>
                </li>
            </ul>

            <h3>System-Level Recovery:</h3>
            <ul>
                <li><strong>Normal Restart:</strong> Handled automatically by DB2 after a subsystem crash. Involves log analysis, Redo phase, and Undo phase.</li>
                <li><strong>Conditional Restart:</strong> Used when normal restart fails. Requires manual intervention using `ACCESS(MAINT)` mode and potentially `RECOVER POSTPONED` or other specialized procedures to resolve log or BSDS issues. Requires expertise!</li>
                <li><strong>Disaster Recovery (using System-Level Backup):</strong>
                    <ol>
                        <li>Restore system volumes (including DB2 datasets and logs) from `BACKUP SYSTEM` copies at the DR site.</li>
                        <li>Start z/OS and necessary subsystems.</li>
                        <li>Start DB2. It will typically perform restart recovery based on the restored logs.</li>
                        <li>Apply any additional archive logs shipped from the primary site if aiming for a more current recovery point (log shipping).</li>
                        <li>Validate system and application functionality.</li>
                    </ol>
                </li>
            </ul>
        </section>

        <section id="advanced">
            <h2>Advanced Topics & Considerations</h2>
            <p>
                Beyond the basics, several advanced topics influence backup and recovery strategies.
            </p>
            <ul>
                <li><strong>Data Sharing Recovery:</strong> Recovery involves coordination between members via the Coupling Facility and IRLM. Global locks and Group Buffer Pool (GBP) recovery add complexity. Member failures require specific restart procedures.</li>
                <li><strong>Temporal Data Recovery:</strong> Recovering system-period temporal tables automatically handles the associated history table. Recovering business-period temporal tables requires careful consideration of the application logic and desired point-in-time.</li>
                <li><strong>Log Management:</strong> Efficient log archival, sufficient active log space, BSDS management, and timely deletion of obsolete archive logs are crucial for both performance and recoverability.</li>
                <li><strong>Automation & Tooling:</strong> Leveraging schedulers, REXX, system automation tools, and vendor products can significantly improve the reliability and efficiency of backup and recovery processes.</li>
                <li><strong>Cloud Integration:</strong> Storing backups in the cloud (e.g., using Transparent Cloud Tiering - TCT) offers scalability and potential cost savings but requires careful planning for network bandwidth and recovery times.</li>
                <li><strong>Backup Encryption:</strong> Encrypting backup datasets adds a layer of security, especially if backups are sent offsite or to the cloud.</li>
            </ul>
            <div class="note">
                Data Sharing recovery, in particular, requires a deep understanding of how the GBP, CF, and inter-member communication impact log merging and consistency during restart or recovery operations.
            </div>
        </section>

        <section id="conclusion">
            <h2>Conclusion</h2>
            <p>
                A comprehensive DB2 backup and recovery strategy is essential for maintaining data availability and integrity. By implementing appropriate backup procedures using utilities like `COPY`, establishing efficient recovery processes with `RECOVER`, and planning for various failure scenarios, organizations can minimize the impact of data loss incidents and ensure business continuity.
            </p>
            <p>
                Regular testing, continuous improvement based on those tests, and adaptation to emerging technologies and changing business requirements (RPO/RTO) are key to maintaining effective data protection over time. The technologies and methodologies described provide a solid foundation for protecting DB2 data in demanding mainframe environments.
            </p>
            <div class="diagram">
                Backup -> Plan -> Test -> Recover -> Validate -> Repeat!
            </div>
        </section>

        <footer>
            <p>Made with passion for mainframes & DB2. &copy; 2025 Tom Deloddere.</p>

            <p>Sources for Chapter 5:
                <a href="https://www.ibm.com/docs/en/db2-for-zos/12?topic=recovery-backing-up-recovering-your-data" target="_blank" rel="noopener noreferrer">ibm.com</a>,
                <a href="https://planetmainframe.com/2024/11/optimizing-data-management-in-mainframe-environments-key-strategies-for-effective-backup-and-recovery/" target="_blank" rel="noopener noreferrer">planetmainframe.com</a>,
                <a href="https://www.triton.co.uk/service/infrastructure-services/z-mainframe-availability-and-resiliency-service-zmars/back-up-recovery/" target="_blank" rel="noopener noreferrer">triton.co.uk</a>,
                <a href="https://www.rocketsoftware.com/sites/default/files/resource_files/DBR%20for%20DB2%20FINAL.pdf" target="_blank" rel="noopener noreferrer">rocketsoftware.com</a>,
                <a href="https://share.confex.com/share/118/webprogram/Handout/Session10499/SHARE_Atlanta_DR%2010501-V2.pdf" target="_blank" rel="noopener noreferrer">share.confex.com</a>,
                <a href="https://help.sap.com/doc/saphelp_snc70/7.0/en-US/b0/0d72a0b9e611d2951500a0c930df15/content.htm" target="_blank" rel="noopener noreferrer">help.sap.com</a>,
                <a href="https://docs.broadcom.com/docs/recovery-suite-for-db2-for-zos" target="_blank" rel="noopener noreferrer">docs.broadcom.com</a>,
                <a href="https://techdocs.broadcom.com/us/en/ca-mainframe-software/database-management/ca-recovery-analyzer-for-db2-for-z-os/20-0/using/perform-disaster-recovery/perform-a-disaster-recovery.html" target="_blank" rel="noopener noreferrer">techdocs.broadcom.com</a>,
                <a href="https://www.idug.org/news/db2z-and-redirected-recovery-user-experience-part-1-what-it-is-and-why-and-how" target="_blank" rel="noopener noreferrer">idug.org</a>,
                <a href="https://www.ibm.com/docs/en/db2-for-zos/12?topic=data-preparations-disaster-recovery" target="_blank" rel="noopener noreferrer">ibm.com</a>
            </p>
        </footer>

    </div>
    <script>
        const backToQuizBtn = document.getElementById('back-to-quiz-btn');
            backToQuizBtn.addEventListener('click', function() {
                window.location.href = '../index.html';
            });
    </script>

</body>
</html>
